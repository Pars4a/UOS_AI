<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- prevent zooming on mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Haawall - University Assistant</title>
    <link rel="shortcut icon" href="static/images/uos-icon.ico" type="image/x-icon">
    <link rel="stylesheet" href="static/style.css">
    <style>
       
    </style>
</head>
<body>
    <!-- main header -->
    <div class="header">
        <!-- hamburger menu for mobile -->
        <div class="mobile-menu-icon" onclick="toggleMenu()">☰</div>
      
        <!-- left nav links -->
        <nav class="main-nav left desktop-only">
          <a href="/" class="nav-link active">Home</a>
          <a href="about" class="nav-link">About</a>
        </nav>
      
        <!-- university logo -->
        <div class="logo"> 
            <div class="logo-icon"></div>
        </div>
      
        <!-- right side controls -->
        <nav class="main-nav right desktop-only">
          <button onclick="toggleLanguage()" id="langSwitchBtn" class="lang-toggle">
            کوردی
          </button>
          <a href="contact" class="nav-link contact-btn">Contact Us</a>
        </nav>
        
        <!-- help button with question mark -->
        <button class="faq-button" onclick="toggleFAQ()" id="faqButton">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
          </svg>
        </button>
        
        <!-- FAQ dropdown menu -->
        <div class="faq-dropdown" id="faqDropdown">
          <div class="faq-header">Frequently Asked Questions</div>
          <div class="faq-list" id="faqList">
            <!-- FAQ items added by javascript -->
          </div>
        </div>

        <!-- mobile language switcher -->
        <div class="mobile-controls">
          <button onclick="toggleLanguage()" id="langSwitchBtnMobile" class="lang-toggle">
            کوردی
          </button>
        </div>

        <!-- mobile dropdown menu -->
        <div class="mobile-menu hidden" id="mobileMenu">
          <a href="/" class="nav-link active">Home</a>
          <a href="/about" class="nav-link">About</a>
          <a href="/contact" class="nav-link contact-btn">Contact Us</a>
        </div>
    </div>
      
    <!-- quick action buttons -->
    <div class="quick-actions">
        <div class="quick-actions-container">
            <div class="quick-action-btn" onclick="sendExamplePrompt(0)">
                <div class="quick-action-title">Course Information</div>
                <div class="quick-action-text">What courses are available in Computer Engineering?</div>
            </div>
            <div class="quick-action-btn" onclick="sendExamplePrompt(1)">
                <div class="quick-action-title">Campus Services</div>
                <div class="quick-action-text">When The Next Semester Starts?</div>
            </div>
            <div class="quick-action-btn" onclick="sendExamplePrompt(2)">
                <div class="quick-action-title">Registration Help</div>
                <div class="quick-action-text">How do I register for courses?</div>
            </div>
            <div class="quick-action-btn" onclick="sendExamplePrompt(3)">
                <div class="quick-action-title">Campus Navigation</div>
                <div class="quick-action-text">Where is the Computer Engineering building?</div>
            </div>
        </div>
    </div>

    <!-- chatt area -->
    <div class="chat-container">

        <!-- welcome screen -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-logo"> 
                <img src="static/images/uoswelcomelogo.png" alt="Logo"> 
            </div>
            <h1 class="welcome-title">How can I help you today?</h1>
            <p class="welcome-subtitle">I'm Haawall, your University of Sulaimani assistant. Ask me about courses, schedules, campus info, and more.</p>
        </div>

        <!-- chat messages go here -->
        <div class="messages" id="messages"></div>
        
        <!-- typing dots animation -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-avatar"></div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    </div>

    <!-- message input at bottom -->
    <div class="input-area" id="inputArea">
        <div class="input-container">
            <!-- text input box -->
            <textarea 
                class="message-input" 
                id="messageInput" 
                placeholder="Message Haawall..."
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="adjustTextareaHeight()"
                onfocus="handleInputFocus()"
                onblur="handleInputBlur()"
            ></textarea>
            <!-- send button -->
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
<script>
// global variables
let currentLang = 'en';
let faqOpen = false;
let isAIResponding = false;
let isTypingComplete = false;

// FAQ questions in both languages
const faqQuestions = {
  en: [
    "Engineering College Foundation Building?",
    "Where are the statistic staffs?", 
    "Where is the board of department heads?",
    "When does the semester start?",
    "When is the employees' sessions?",
    "What are the library hours?",
    "What departments does the engineering college have?",
    "Where is the registration?",
    "Parallel Program Prices",
    "Where is the central cafeteria?"
  ],
  ku: [
    "بینای کۆلێژی ئەندازیاری",
    "ژمێریاری لە کوێیە؟",
    "سەرۆکایەتی لە کوێیە؟",
    "کەی وەرزی خوێندن دەستپێدەکات؟",
    "دەوامی کارمەندان کەی بۆ کایە؟",
    "کاتەکانی کتێبخانە لە کەیەوەیە؟",
    "بەشەکانی کۆلێژی ئەندازیاری چین؟ ",
    "تۆمار لەکوێیە؟ ",
    "کرێی پاراڵێلی بەشەکان چەندە؟",
    "کافتریای ناوەند لەکوێیە؟ "
  ]
};

// UI text translations
const translations = {
  en: {
    switchText: "کوردی",
    welcomeTitle: "How can I help you today?",
    welcomeSubtitle: "I'm Haawall, your University of Sulaimani assistant. Ask me about courses, schedules, campus info, and more.",
    prompts: [
      { title: "Course Information", text: "What courses are available in Computer Engineering?" },
      { title: "Campus Services", text: "When Does the next semester starts??" },
      { title: "Registration Help", text: "How do I register for courses?" },
      { title: "Campus Navigation", text: "Where is the Computer Engineering building?" },
    ],
    inputPlaceholder: "Message Haawall...",
    faqHeader: "Frequently Asked Questions"
  },
  ku: {
    switchText: "English",
    welcomeTitle: "چۆن دەتوانم یارمەتیت بدەم؟",
    welcomeSubtitle: "من هاوەڵم، یارمەتیدەری زانکۆی سلێمانی. پرسیارەکانت لەسەر وانەکان، کاتی خوێندن، زانیاری زانکۆ و زیاتر بپرسە.",
    prompts: [
      { title: "زانیاری وانە", text: "وانەکانی ئەندازیاری کۆمپیوتەر چییە؟" },
      { title: "خزمەتگوزاری زانکۆ", text: "کەی دەوام دەستپێدەکاتەوە؟" },
      { title: "یارمەتیدانی تۆمارکردن", text: "چۆن تۆمار دەکەم بۆ وانەکان؟" },
      { title: "ڕێنوێنی زانکۆ", text: "بینای ئەندازیاری کۆمپیوتەر لە کوێیە؟" },
    ],
    inputPlaceholder: "...پەیامێک بنێرە بۆ هاوەڵ",
    faqHeader: "پرسیارە دووبارەکان"
  }
};

// format text with basic HTML
function formatMessage(message) {
  // line breaks to HTML
  message = message.replace(/\n/g, '<br>');
  
  // make numbered lists bold
  message = message.replace(/^(\d+\.\s)/gm, '<strong>$1</strong>');
  
  // bullet points
  message = message.replace(/^[-•]\s/gm, '• ');
  
  // bold text between **
  message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  
  // make specific phrases bold
  message = message.replace(/^(To get the most accurate.*?):/gm, '<strong>$1:</strong>');
  message = message.replace(/^(For the most current.*?):/gm, '<strong>$1:</strong>');
  
  return message;
}

// improved kurdish text detection - only checks the actual content
function detectKurdishText(text) {
  // remove HTML tags first
  const cleanText = text.replace(/<[^>]*>/g, '');
  
  // kurdish unicode ranges
  const kurdishPattern = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;
  
  // count kurdish vs latin characters
  const kurdishChars = (cleanText.match(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/g) || []).length;
  const latinChars = (cleanText.match(/[a-zA-Z]/g) || []).length;
  const totalChars = kurdishChars + latinChars;
  
  // only apply RTL if kurdish characters make up more than 30% of the text
  if (totalChars === 0) return false;
  return (kurdishChars / totalChars) > 0.3;
}

// enable/disable input based on AI status
function updateInputState() {
    const input = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const quickActionBtns = document.querySelectorAll('.quick-action-btn');
    
    if (isAIResponding) {
        // disable while AI responds
        input.disabled = true;
        input.classList.add('loading');
        sendButton.disabled = true;
        sendButton.classList.add('loading');
        
        // disable quick action buttons
        quickActionBtns.forEach(btn => {
            btn.classList.add('loading');
        });
        
        // update placeholder
        const originalPlaceholder = input.placeholder;
        input.setAttribute('data-original-placeholder', originalPlaceholder);
        input.placeholder = currentLang === 'ku' 
            ? '...چاوەڕێ بکە تا هاوەڵ وەڵامت دەداتەوە'
            : 'Please wait for Haawall to finish responding...';
    } else {
        // re-enable input
        input.disabled = false;
        input.classList.remove('loading');
        sendButton.disabled = false;
        sendButton.classList.remove('loading');
        
        // re-enable quick action buttons
        quickActionBtns.forEach(btn => {
            btn.classList.remove('loading');
        });
        
        // restore placeholder
        const originalPlaceholder = input.getAttribute('data-original-placeholder');
        if (originalPlaceholder) {
            input.placeholder = originalPlaceholder;
        } else {
            input.placeholder = translations[currentLang].inputPlaceholder;
        }
        
        // focus for better UX
        input.focus();
    }
}

// show loading overlay
function showLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.add('show');
    }
}

// hide loading overlay
function hideLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.remove('show');
    }
}

// add message skeleton while loading
function addMessageSkeleton() {
    const messagesContainer = document.getElementById('messages');
    const skeletonDiv = document.createElement('div');
    skeletonDiv.className = 'message-skeleton';
    skeletonDiv.id = 'messageSkeleton';
    
    skeletonDiv.innerHTML = `
        <div class="skeleton-avatar"></div>
        <div class="skeleton-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
        </div>
    `;
    
    messagesContainer.appendChild(skeletonDiv);
    scrollToBottom();
}

//Free scrolling during AI response ->>. no forced scrolling
function typeWriter(element, text, speed = 20, showCursor = true) {
    element.innerHTML = '';
    let i = 0;
    
    // User can now scroll freely during AI response
    let userHasScrolled = false;
    let isAtBottomBeforeTyping = isScrolledToBottom();
    
    //only apply RTL if the actual message content contains Kurdish text
    const isKurdishContent = detectKurdishText(text);
    if (isKurdishContent) {
      element.classList.add('rtl-text');
      element.parentElement.classList.add('rtl-message');
    } else {
      // Make sure to remove RTL classes for English content
      element.classList.remove('rtl-text');
      element.parentElement.classList.remove('rtl-message');
    }
    
    // set AI responding state
    isAIResponding = true;
    isTypingComplete = false;
    updateInputState();
    
    // add cursor styles if not there
    if (!document.querySelector('#cursor-style')) {
        const style = document.createElement('style');
        style.id = 'cursor-style';
        style.textContent = `
            .typing-cursor {
                display: inline-block;
                background-color: #333;
                width: 2px;
                height: 1.2em;
                margin-left: 2px;
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
            
            .ai-response-header {
                font-weight: bold;
                font-size: 1.1em;
                margin-bottom: 8px;
                color: #2c3e50;
                border-bottom: 2px solid #3498db;
                padding-bottom: 5px;
                display: inline-block;
            }
            
            .message.assistant .message-content {
                line-height: 1.6;
            }
            
            /* disabled input styles */
            .input-container.disabled {
                opacity: 0.6;
                pointer-events: none;
            }
            
            .message-input:disabled {
                background-color: #f5f5f5;
                cursor: not-allowed;
            }
            
            .send-button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            
            /* typing status */
            .typing-status {
                position: absolute;
                top: -25px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(52, 152, 219, 0.1);
                color: #3498db;
                padding: 5px 15px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: 500;
                white-space: nowrap;
                z-index: 100;
            }
            
            /* Scroll to bottom indicator - REMOVED */
            
            /* Mobile adjustments */
            @media (max-width: 768px) {
                /* Mobile styles */
            }
            
            /* RTL text - ONLY apply when content is actually Kurdish */
            .rtl-text {
                direction: rtl;
                text-align: right;
                font-family: 'Segoe UI', 'Tahoma', 'Arial Unicode MS', sans-serif;
                line-height: 1.6;
            }
            
            /* RTL message container */
            .rtl-message {
                direction: rtl;
            }
            
            /* avatar position for RTL */
            .rtl-message .message-avatar {
                order: 2;
                margin-left: 12px;
                margin-right: 0;
            }
            
            .rtl-message .message-content {
                order: 1;
            }
            
            /* fix lists for RTL */
            .rtl-text ul, .rtl-text ol {
                text-align: right;
                direction: rtl;
            }
            
            .rtl-text li {
                text-align: right;
            }
            
            /* Default LTR styling for English content */
            .message.assistant .message-content:not(.rtl-text) {
                direction: ltr;
                text-align: left;
            }
        `;
        document.head.appendChild(style);
    }
    
    // add typing status
    const inputArea = document.getElementById('inputArea');
    const typingStatus = document.createElement('div');
    typingStatus.className = 'typing-status';
    typingStatus.id = 'typingStatus';
    typingStatus.textContent = currentLang === 'ku' ? '...هاوەڵ وەڵام دەداتەوە    ' : 'Haawall is responding...';
    inputArea.appendChild(typingStatus);
    
    //Track user scrolling without interfering
    const messagesContainer = document.getElementById('messages');
    let scrollTimeout;
    
    const handleScroll = () => {
        userHasScrolled = true;
        clearTimeout(scrollTimeout);
        
        // reset scroll tracking after user stops scrolling
        scrollTimeout = setTimeout(() => {
            if (isScrolledToBottom()) {
                userHasScrolled = false;
            }
        }, 1000);
    };
    
    // 
    messagesContainer.addEventListener('scroll', handleScroll, { passive: true });
    
    function type() {
        if (i < text.length) {
            const char = text.charAt(i);
            let formattedText = formatMessage(text.substring(0, i + 1));
            
            // add header styling
            if (i === 0 || (i > 0 && text.substring(0, i).includes('\n') && text.substring(i).trim().length > 0)) {
                const lines = formattedText.split('<br>');
                if (lines.length > 0 && lines[0].trim().length > 0) {
                    lines[0] = `<div class="ai-response-header">${lines[0]}</div>`;
                    formattedText = lines.join('<br>');
                }
            }
            
            element.innerHTML = formattedText;
            
            if (showCursor) {
                element.innerHTML += '<span class="typing-cursor"></span>';
            }
            
            i++;
            
            // variable typing speed
            let currentSpeed = speed;
            if (char === '.' || char === '!' || char === '?') {
                currentSpeed = speed * 4; 
            } else if (char === ',' || char === ';' || char === ':') {
                currentSpeed = speed * 2; 
            } else if (char === ' ') {
                currentSpeed = speed * 0.3; 
            }
            
            setTimeout(type, currentSpeed);
            
            //only auto-scroll if user was at bottom when typing started AND hasn't scrolled away
            if (isAtBottomBeforeTyping && !userHasScrolled) {
                scrollToBottom();
            }
        } else {
            // typing done
            isTypingComplete = true;
            
            // clean up
            messagesContainer.removeEventListener('scroll', handleScroll);
            
            // remove typing status
            const statusElement = document.getElementById('typingStatus');
            if (statusElement) {
                statusElement.remove();
            }
            
            if (showCursor) {
                setTimeout(() => {
                    let finalText = formatMessage(text);
                    // apply header styling
                    const lines = finalText.split('<br>');
                    if (lines.length > 0 && lines[0].trim().length > 0) {
                        lines[0] = `<div class="ai-response-header">${lines[0]}</div>`;
                        finalText = lines.join('<br>');
                    }
                    element.innerHTML = finalText;
                    
                    // Only scroll if user was at bottom and hasn't scrolled
                    if (isAtBottomBeforeTyping && !userHasScrolled) {
                        scrollToBottom();
                    }
                    
                    // re-enable input
                    isAIResponding = false;
                    updateInputState();
                }, 500); 
            } else {
                // re-enable input immediately
                isAIResponding = false;
                updateInputState();
            }
        }
    }
    
    type();
    
    return new Promise(resolve => {
        const checkComplete = () => {
            if (i >= text.length) {
                setTimeout(() => {
                    isAIResponding = false;
                    updateInputState();
                    resolve();
                }, showCursor ? 500 : 0);
            } else {
                setTimeout(checkComplete, 100);
            }
        };
        checkComplete();
    });
}

//function to check if user is at bottom of scroll
function isScrolledToBottom() {
    const messagesContainer = document.getElementById('messages');
    if (!messagesContainer) return true;
    
    const threshold = 50; // pixels from bottom
    return messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + threshold;
}

// toggle FAQ dropdown
function toggleFAQ() {
  const dropdown = document.getElementById('faqDropdown');
  const button = document.getElementById('faqButton');
  
  faqOpen = !faqOpen;
  
  if (faqOpen) {
    dropdown.classList.add('show');
    button.style.transform = 'rotate(180deg)';
    populateFAQList();
  } else {
    dropdown.classList.remove('show');
    button.style.transform = 'rotate(0deg)';
  }
}

// fill FAQ list with questions
function populateFAQList() {
  const faqList = document.getElementById('faqList');
  faqList.innerHTML = '';
  
  const currentFaqQuestions = faqQuestions[currentLang];
  
  currentFaqQuestions.forEach((question, index) => {
    const faqItem = document.createElement('div');
    faqItem.className = 'faq-item';
    faqItem.textContent = question;
    faqItem.onclick = () => {
      sendFAQQuestion(question);
      toggleFAQ();
    };
    faqList.appendChild(faqItem);
  });
}

// send FAQ question
function sendFAQQuestion(question) {
  if (isAIResponding) {
    return;
  }
  document.getElementById('messageInput').value = question;
  sendMessage(question);
}

// toggle mobile menu
function toggleMenu() {
  const menu = document.getElementById('mobileMenu');
  menu.classList.toggle('hidden');
}

// handle enter key
function handleKeyDown(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    
    // only send if not responding
    if (!isAIResponding) {
      sendMessage();
    }
  }
}

// auto-resize textarea
function adjustTextareaHeight() {
  const textarea = document.getElementById('messageInput');
  
  // don't adjust if disabled
  if (textarea.disabled) return;
  
  // reset height to calculate new height
  textarea.style.height = 'auto';
  
  // set new height with max limit
  const newHeight = Math.min(textarea.scrollHeight, 120);
  textarea.style.height = newHeight + 'px';
  
  // update scroll after resize - only if user was at bottom
  if (isScrolledToBottom()) {
    requestAnimationFrame(() => {
        scrollToBottom();
    });
  }
}

// handle mobile keyboard opening
function handleInputFocus() {
  const inputArea = document.getElementById('inputArea');
  
  if (window.innerWidth <= 768) {
    inputArea.classList.add('keyboard-open');
    
    // Only scroll if user was at bottom
    if (isScrolledToBottom()) {
        setTimeout(() => scrollToBottom(), 100);
        setTimeout(() => scrollToBottom(), 300);
        setTimeout(() => scrollToBottom(), 500);
    }
  }
}

// handle mobile keyboard closing
function handleInputBlur() {
  const inputArea = document.getElementById('inputArea');
  
  if (window.innerWidth <= 768) {
    inputArea.classList.remove('keyboard-open');
    
    // Only scroll if user was at bottom
    if (isScrolledToBottom()) {
        setTimeout(() => {
            scrollToBottom();
        }, 400);
    }
  }
}

// send example prompt
function sendExamplePrompt(promptIndex) {
  if (isAIResponding) {
    // show user feedback
    const warningMsg = currentLang === 'ku' 
      ? 'تکایە چاوەڕێ بکە تا هاوەڵ وەڵام بداتەوە'
      : 'Please wait for Haawall to finish responding';
    
    // could add a toast notification here
    console.log(warningMsg);
    return;
  }
  
  const prompt = translations[currentLang].prompts[promptIndex].text;
  document.getElementById('messageInput').value = prompt;
  sendMessage(prompt);
}

// main send message function
function sendMessage(customMessage = null) {
  const input = document.getElementById('messageInput');
  const sendButton = document.getElementById('sendButton');
  const message = customMessage ?? input.value.trim();

  // prevent sending if AI is responding
  if (isAIResponding) {
    // show warning
    const warningMsg = currentLang === 'ku' 
      ? 'تکایە چاوەڕێ بکە تا هاوەڵ وەڵام بداتەوە'
      : 'Please wait for Haawall to finish responding';
    
    console.log(warningMsg);
    return;
  }

  if (message === '') return;

  // hide welcome screen
  document.getElementById('welcomeScreen').classList.add('hidden');
  
  // set AI responding state
  isAIResponding = true;
  updateInputState();

  addMessage(message, 'user');
  input.value = '';
  input.style.height = 'auto';

  // show enhanced loading states
  showTypingIndicator();
  addMessageSkeleton();

  fetch('/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ 
      message: message,
      instruction: "Please answer only the single question asked. Do not provide additional information or answer multiple questions at once."
    })
  })
    .then(response => {
      // remove skeleton on response
      const skeleton = document.getElementById('messageSkeleton');
      if (skeleton) {
        skeleton.remove();
      }
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      hideTypingIndicator();
      
      // small delay for better UX
      setTimeout(() => {
        if (data.response) {
          addMessage(data.response, 'assistant');
        } else if (data.error) {
          const errorMsg = currentLang === 'ku'
            ? 'ببورە، هەڵەیەک ڕویدا: ' + data.error
            : 'I apologize, but I encountered an error: ' + data.error;
          addMessage(errorMsg, 'assistant', true);
        } else {
          const unexpectedMsg = currentLang === 'ku'
            ? 'وەلامێکی نەزانراوە وەرگیرا. تکایە دواتر هەوڵبدەوە.'
            : 'I received an unexpected response. Please try again.';
          addMessage(unexpectedMsg, 'assistant', true);
        }
      }, 300);
    })
    .catch(error => {
      // remove skeleton on error
      const skeleton = document.getElementById('messageSkeleton');
      if (skeleton) {
        skeleton.remove();
      }
      
      hideTypingIndicator();
      console.error('Error:', error);
      
      setTimeout(() => {
        const connectionErrorMsg = currentLang === 'ku'
          ? 'کێشەیەک هەیە لەگەڵ بەستنی پەیوەندی. تکایە پەیوەندیدا بپشکنە و دواتر هەوڵبدەوە.'
          : 'I\'m having trouble connecting right now. Please check your connection and try again.';
        addMessage(connectionErrorMsg, 'assistant', true);
      }, 300);
    })
    .finally(() => {
      // ensure input is re-enabled
      if (!isAIResponding) {
        updateInputState();
      }
    });
}

// add message to chat with CORRECTED RTL support
function addMessage(message, sender, isError = false) {
  const messagesContainer = document.getElementById('messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;

  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = sender === 'user' ? 'U' : '';

  const content = document.createElement('div');
  content.className = isError ? 'error-message' : 'message-content';
  
  //only apply RTL if the message actually contains Kurdish text
  // Don't base it on UI language, base it on the actual content
  if (sender === 'assistant' && detectKurdishText(message)) {
    content.classList.add('rtl-text');
    messageDiv.classList.add('rtl-message');
  } else {
    // Explicitly ensure LTR for non-Kurdish content
    content.classList.remove('rtl-text');
    messageDiv.classList.remove('rtl-message');
  }
  
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(content);
  messagesContainer.appendChild(messageDiv);

  // show user messages immediately
  if (sender === 'user') {
    content.innerHTML = formatMessage(message);
    // Only auto-scroll for user messages if they were at bottom
    if (isScrolledToBottom()) {
        scrollToBottom();
    }
  } else {
    // use typewriter for AI responses
    typeWriter(content, message, 20, true).then(() => {
      // final scroll after typing - only if user didn't scroll away
      if (isScrolledToBottom()) {
          setTimeout(() => {
              scrollToBottom();
          }, 100);
      }
    });
  }
}

// show scroll to bottom indicator - REMOVED
function showScrollToBottomIndicator() {
  // Removed - no longer showing scroll indicator
}

// hide scroll to bottom indicator - REMOVED  
function hideScrollToBottomIndicator() {
  // Removed - no longer showing scroll indicator
}

// scroll chat to bottom
function scrollToBottom() {
  const messagesContainer = document.getElementById('messages');
  const inputArea = document.getElementById('inputArea');
  
  if (messagesContainer && inputArea) {
    // get actual input area height
    const inputAreaHeight = inputArea.getBoundingClientRect().height;
    
    // add extra padding
    const extraPadding = 30;
    
    // set dynamic padding
    messagesContainer.style.paddingBottom = `${inputAreaHeight + extraPadding}px`;
    
    // force scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Additional scroll for mobile - but only if needed
    if (window.innerWidth <= 768) {
      setTimeout(() => {
        if (isScrolledToBottom()) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }, 50);
    }
  }
}

// show typing indicator
function showTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) {
    indicator.style.display = 'flex';
    
    // Only scroll if user was at bottom
    if (isScrolledToBottom()) {
        setTimeout(() => scrollToBottom(), 50);
        setTimeout(() => scrollToBottom(), 150);
    }
  }
}

// hide typing indicator
function hideTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) {
    indicator.style.display = 'none';
  }
  
  // Only scroll if user is at bottom
  if (isScrolledToBottom()) {
      setTimeout(() => scrollToBottom(), 50);
  }
}

// switch between languages
function toggleLanguage() {
  currentLang = currentLang === 'en' ? 'ku' : 'en';
  const t = translations[currentLang];

  // update language buttons
  document.getElementById('langSwitchBtn').innerText = t.switchText;
  document.getElementById('langSwitchBtnMobile').innerText = t.switchText;
  
  // update welcome screen
  document.querySelector('.welcome-title').innerText = t.welcomeTitle;
  document.querySelector('.welcome-subtitle').innerText = t.welcomeSubtitle;
  
  // update input placeholder
  updateInputState();

  // update FAQ header
  const faqHeader = document.querySelector('.faq-header');
  if (faqHeader) {
    faqHeader.textContent = t.faqHeader;
  }

  // refresh FAQ list if open
  if (faqOpen) {
    populateFAQList();
  }

  // update quick action buttons
  const quickActionBtns = document.querySelectorAll('.quick-action-btn');
  quickActionBtns.forEach((btn, i) => {
    btn.querySelector('.quick-action-title').innerText = t.prompts[i].title;
    btn.querySelector('.quick-action-text').innerText = t.prompts[i].text;
  });
  
  // update typing status if it exists
  const typingStatus = document.getElementById('typingStatus');
  if (typingStatus) {
    typingStatus.textContent = currentLang === 'ku' ? '...هاوەڵ وەڵامت دەداتەوە' : 'Haawall is responding...';
  }
}

// mobile viewport fixes
function initializeMobileFixes() {
  // better viewport height for mobile browsers
  function setViewportHeight() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  
  setViewportHeight();
  
  // handle resize with debouncing
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      setViewportHeight();
      // Only scroll if user was at bottom
      if (isScrolledToBottom()) {
          scrollToBottom();
      }
    }, 100);
  });
  
  // handle orientation change
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      setViewportHeight();
      // Only scroll if user was at bottom
      if (isScrolledToBottom()) {
          scrollToBottom();
      }
    }, 700); 
  });
  
  // detect keyboard open/close
  let initialViewportHeight = window.innerHeight;
  let keyboardOpen = false;
  
  window.addEventListener('resize', () => {
    const currentHeight = window.innerHeight;
    const heightDifference = initialViewportHeight - currentHeight;
    
    if (heightDifference > 150 && !keyboardOpen) {
      // keyboard opened
      keyboardOpen = true;
      document.body.classList.add('keyboard-open');
      // Only auto-scroll if user was at bottom
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 300);
          setTimeout(() => scrollToBottom(), 600);
      }
    } else if (heightDifference < 150 && keyboardOpen) {
      // keyboard closed
      keyboardOpen = false;
      document.body.classList.remove('keyboard-open');
      // Only auto-scroll if user was at bottom
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 300);
          setTimeout(() => scrollToBottom(), 600);
      }
    }
  });
}

// iOS safari fixes
function initializeIOSFixes() {
  // prevent zoom on input focus
  const viewportMeta = document.querySelector('meta[name="viewport"]');
  if (viewportMeta) {
    viewportMeta.content = 'width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0';
  }
  
  // better focus handling for iOS
  document.addEventListener('focusin', function(e) {
    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
      // Only auto-scroll if user was at bottom
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 100);
          setTimeout(() => scrollToBottom(), 400);
          setTimeout(() => scrollToBottom(), 700);
      }
    }
  });
  
  // handle iOS keyboard hiding
  document.addEventListener('focusout', function(e) {
    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
      // Only auto-scroll if user was at bottom
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 300);
      }
    }
  });
}

// android fixes
function initializeAndroidFixes() {
  let originalHeight = window.innerHeight;
  
  window.addEventListener('resize', function() {
    const currentHeight = window.innerHeight;
    const diff = originalHeight - currentHeight;
    
    if (diff > 150) {
      // keyboard is open
      document.body.style.paddingBottom = '0px';
      // Only auto-scroll if user was at bottom
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 100);
      }
    } else {
      // keyboard is closed
      document.body.style.paddingBottom = '';
      // Only auto-scroll if user was at bottom
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 100);
      }
    }
  });
}

// close FAQ when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('faqDropdown');
  const button = document.getElementById('faqButton');
  
  if (faqOpen && !dropdown.contains(event.target) && !button.contains(event.target)) {
    toggleFAQ();
  }
});

// initialize when page loads
document.addEventListener('DOMContentLoaded', function () {
  // ensure input starts correctly
  isAIResponding = false;
  updateInputState();
  
  document.getElementById('messageInput').focus();
  
  // add styling to prevent message cutoff
  const style = document.createElement('style');
  style.textContent = `
    .messages {
      padding-bottom: 140px !important;
      scroll-behavior: smooth;
    }
    
    .chat-container {
      padding-bottom: 0 !important;
      position: relative;
    }
    
    .message:last-child {
      margin-bottom: 20px !important;
    }
    
    .input-area {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 1000 !important;
      background: white !important;
      border-top: 1px solid #eee !important;
      padding: 1rem !important;
    }
    
    @media (max-width: 768px) {
      .messages {
        padding-bottom: 160px !important;
      }
      
      .keyboard-open .messages {
        padding-bottom: 200px !important;
      }
      
      .input-area {
        padding: 0.75rem !important;
      }
    }
  `;
  document.head.appendChild(style);
  
  // mobile fixes
  if (window.innerWidth <= 768) {
    initializeMobileFixes();
  }
  
  // iOS fixes
  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
    initializeIOSFixes();
  }
  
  // android fixes
  if (navigator.userAgent.toLowerCase().indexOf('android') > -1) {
    initializeAndroidFixes();
  }
  
  // Initial scroll setup - only if at bottom
  if (isScrolledToBottom()) {
      setTimeout(() => scrollToBottom(), 100);
      setTimeout(() => scrollToBottom(), 300);
      setTimeout(() => scrollToBottom(), 500);
  }
});
</script>
</body>
</html>